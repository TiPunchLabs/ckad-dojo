# Implementation Plan: Fix Score Expansion Details

**Branch**: `012-fix-score-expansion` | **Date**: 2025-12-11 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/012-fix-score-expansion/spec.md`

## Summary

Fix BUG-001 where the score modal expansion doesn't show detailed criteria. The root cause is in `ckad-score.sh` where scoring function output (containing criteria lines with pass/fail markers) is captured but never displayed, causing the web API to have no criteria data to parse.

## Technical Context

**Language/Version**: Bash 4.0+ (scripts), Python 3.8+ (web server), JavaScript ES6+ (frontend)
**Primary Dependencies**: Python standard library only (http.server, json, re), vanilla JavaScript, marked.js, highlight.js
**Storage**: N/A (in-memory state only)
**Testing**: Manual testing via web interface
**Target Platform**: Linux (local development)
**Project Type**: Web application (existing)
**Performance Goals**: Scoring completes within 60 seconds
**Constraints**: No external dependencies, standard library only

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Script-First Automation | PASS | Modifying existing ckad-score.sh script |
| II. Kubernetes-Native Tooling | PASS | No changes to K8s tooling |
| III. Automated Scoring | PASS | Enhances scoring output with detailed criteria |
| IV. Exam Fidelity | PASS | No impact on exam conditions |
| V. Idempotent Operations | PASS | Score script remains read-only |
| VI. Modern UI | PASS | Improves UI with detailed criteria display |

**All gates PASS** - No violations.

## Project Structure

### Documentation (this feature)

```text
specs/012-fix-score-expansion/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/          # Quality checklists
│   └── requirements.md
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code (files to modify)

```text
scripts/
└── ckad-score.sh           # Main fix: output criteria before score line

web/
├── server.py               # Already has parse_criteria_from_output (verify)
└── js/
    └── app.js              # Already has expand/collapse logic (verify)
```

**Structure Decision**: Bug fix in existing files. No new files needed.

## Root Cause Analysis

### Problem Flow

1. **ckad-score.sh (line 164)**:
   ```bash
   score_result=$("score_q$qnum" 2>/dev/null || echo "0/0")
   ```
   - Scoring function output is captured in `$score_result`
   - Only `tail -1` (the score) is extracted
   - Criteria lines (✓/✗) are lost - never echoed

2. **web/server.py**:
   - `parse_criteria_from_output()` looks for criteria in scoring output
   - Since `ckad-score.sh` doesn't output criteria, nothing is found

3. **web/js/app.js**:
   - `renderQuestionScores()` generates HTML with criteria
   - `toggleQuestionCriteria()` handles expand/collapse
   - Logic is correct but `criteria` array is always empty

### Solution

Modify `ckad-score.sh` to echo the full scoring function output (including criteria lines) so that:
1. Criteria appear in script output
2. `server.py` can parse them
3. `app.js` can display them

## Implementation Approach

### Phase 1: Fix Scoring Script

Modify the scoring loop in `ckad-score.sh` to:
1. Capture full output from scoring functions
2. Echo the output (including criteria) before extracting score
3. Ensure criteria lines are visible in final output

### Phase 2: Verify End-to-End

1. Verify `server.py` correctly parses criteria from enhanced output
2. Verify `app.js` correctly displays criteria in score modal
3. Test expand/collapse functionality

## Complexity Tracking

No violations - this is a straightforward bug fix.
